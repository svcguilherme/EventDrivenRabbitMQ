      - name: Run API + Consumer and integration smoke test
        shell: bash
        run: |
          set -e

          # Start Consumer in background
          dotnet run -c Release --project Orders.Consumer/Orders.Consumer.csproj > consumer.log 2>&1 &
          CONSUMER_PID=$!

          # Start API in background
          dotnet run -c Release --project Orders.Api/Orders.Api.csproj --urls http://localhost:5000 > api.log 2>&1 &
          API_PID=$!

          # Wait for API to be ready (use /health if you have it; fallback to /swagger)
          for i in {1..30}; do
            if curl -fsS http://localhost:5000/swagger > /dev/null; then
              echo "API is up ✅"
              break
            fi
            sleep 1
          done

          # Send an order
          curl -fsS -X POST http://localhost:5000/orders \
            -H "Content-Type: application/json" \
            -d '{"customerEmail":"ci@example.com","total":123.45}'

          # Give consumer a moment to process
          sleep 3

          # ✅ Assert consumer processed it (adjust the keyword to whatever you log)
          if ! grep -E "OrderCreated|Processing order|Order processed" consumer.log > /dev/null; then
            echo "Consumer did not show expected processing logs ❌"
            echo "---- API LOG ----"
            cat api.log || true
            echo "---- CONSUMER LOG ----"
            cat consumer.log || true
            kill $API_PID || true
            kill $CONSUMER_PID || true
            exit 1
          fi

          echo "Integration check passed ✅"

          # Shutdown
          kill $API_PID || true
          kill $CONSUMER_PID || true
